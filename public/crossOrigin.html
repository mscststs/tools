<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOT FOR TOP</title>
  <script type="module">
    if(self === top){
      window.close();
      throw new Error("Not Expect To Load on Top");
    }


    function changeURL(url){
      let originURL = new URL(url);
      let newHost = originURL.host.replaceAll(".","-");
      const ext = {
        "-com":"-ex1",
        "-cn":"-ex2",
      }
      Object.keys(ext).forEach(key => {
        if(newHost.endsWith(key)){
          newHost = newHost.replace(key, ext[key]);
        }
      });
      if(originURL.protocol === "http:"){
        newHost+="-http-80"
      }else{
        newHost+="-https-443"
      }
      newHost += "-g37.ssl.6aas.cn";
      originURL.protocol = "https:";
      originURL.host = newHost;

      return originURL.href;
    }

    /**
     * 所有支持的跨域调用函数
     * 
     * */
    const rpcFuncs = {
      fetch: async ( {url , options} )=>{
        const response = await fetch(changeURL(url), options);
        const blob = await response.blob();
        
        return {data: blob, transfer: blob};
      }
    }


    window.addEventListener("message", async (event)=>{
      const struct = event.data;
      const port2 = event.ports[0]
      const {type, func, params} = struct;
      if(type === "rpc-call"){
        try{
          const {data,transfer} = await rpcFuncs[func](params);
          port2.postMessage({
            type: "rpc-resolve",
            data: data || ""
          }, transfer);
        }catch(e){
          console.error(e);
          port2.postMessage({
            type: "rpc-reject",
            data: e.message
          });

        }
      }
    });
  </script>
</head>
</html>